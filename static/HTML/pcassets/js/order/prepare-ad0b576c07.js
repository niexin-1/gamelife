$(function(){function t(){var t=$(":checkbox[name='use_id']");d||(t.prop("checked",!1),$(".coupon-item:not(.disable)").eq(0).find("._conpons").prop("checked","checked").siblings().prop("checked",!1)),$(":checkbox[name='use_id']").on("click",function(){$(this).prop("checked")?(t.prop("checked",!1),$(this).prop("checked",!0)):$(this).prop("checked",!1)});var n=$(".order-couponList input").filter(function(){return this.checked});u={type:+n.attr("data-type")||0,discount:+n.attr("data-discount")||0,maxDiscount:+n.attr("data-max-discount")||0,amountOff:+n.attr("data-amount-off")||0,minRental:+n.attr("data-min-rental")||0,checked:n.attr("checked")||0,value:n.attr("value")||""}}$("#check_rules").on("change",function(){$("#submit-btn")[0].style.backgroundColor=$(this)[0].checked?"#f90":"#999"}),$("#form-order").validator({klass:"is-error",before:function(){if(!$("#check_rules")[0].checked)return base.toast("您需要先同意《租号服务协议》"),!1},after:function(){return!0}}),""!=$("#order_id").val()&&($(".hd").find("h1").html("续租订单"),$("title").html("续租订单"),$("#buy_count").val("1"));var n=function(t){var n=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),a=window.location.search.substr(1).match(n);return null!=a?a[2]:null},a=function(t){t=parseFloat((t+"").replace(/[^\d\.-]/g,"")).toFixed(2)+"";var n=t.split(".")[0].split("").reverse(),a=t.split(".")[1],e="";for(i=0;i<n.length;i++)e+=n[i];return e.split("").reverse().join("")+"."+a},e=$("#rent-unit"),o=$("#buy_count"),c=+$("#price-hour").text(),r=+$("#price-day").text(),s=+$("#guarantee-amount").text(),u={},d=0,l=function(){var n,i=$(".content-inner").filter(function(){return $(this).hasClass("active")}).attr("data-value"),d=+o.val();"1"===i||"3"===i?(e.text("小时"),n=+o.attr("data-min"),""!=$("#order_id").val()&&(n=1)):"4"===i?($(".rent-count1").hide(),$(".rent-count2").show()):($(".rent-count1").show(),$(".rent-count2").hide(),e.text("天"),n=1),(!d||d<n)&&(d=n),d>100&&(d=100),o.attr("min",n),o.val(d),o.val(d);var l=0;"1"===i?l=d*c:"2"==i?l=d*r:"3"==i?l=d*c:"4"==i?l=c:"5"==i&&(l=c);var p=parseInt(100*l);l=p/100,$("#rent-amount").text(l);var h=l;$("._conpons").each(function(){this.disabled=+$(this).attr("data-min-rental")>h}),t();var v=0;parseInt(u.minRental)>h&&(u=""),1==i||2==i||4==i?$("#_conpons").val(u.value):$("#_conpons").remove(),u.type&&(1==u.type&&(v=Math.min(Math.min(Math.round(p*(1-u.discount)),u.maxDiscount),p)),2==u.type&&(v=Math.min(u.amountOff,p))),v?$("#coupon-amount").text("-"+parseInt(v)/100):$("#coupon-amount").text("0"),$("#rent-total").text(a(parseInt(p+100*s-v)/100))},p=function(){parseInt($("#buy_count").val())>=100?$(".add").addClass("input-disabled"):$(".add").removeClass("input-disabled"),parseInt($("#buy_count").val())<=o.attr("min")?$(".min").addClass("input-disabled"):$(".min").removeClass("input-disabled")},h=function(){var t=$(".content-inner").filter(function(){return $(this).hasClass("active")}).attr("data-value");""==$("#buy_count").val()?"1"==t&&""==$("#order_id").val()?buy_count=2:buy_count=1:buy_count=$("#buy_count").val(),$("#buy_input").val(t);var e=n("product_id")?decodeURIComponent(n("product_id")):"";""==e&&(e=$("#product_id").val());var o={rent_type:t,buy_count:buy_count,product_id:e};$.ajax({type:"get",url:"/order/findBestMatchPromotion",data:o,dataType:"json",contentType:"application/json",success:function(n){$(".tost-msg").show(),200==n.code?(1==t?$(".tost-msg").html("符合时租满送活动<span class='activity tabs' id='activity'></span>,送<span class='tabs' id='give'></span>小时"):$(".tost-msg").html("符合日租<span class='activity tabs' id='activity'></span>,立减<span class='tabs' id='give'></span>元"),$("#activity").html(n.data),$("#give").html(n.promote_gift),2==t&&$("#rent-total").html(a(parseInt(100*$("#rent-total").html()-100*parseInt(n.promote_gift))/100))):$(".tost-msg").hide()},error:function(t){$(".tost-msg").hide()}})};$(".order-couponList input").on("change",function(){d=1,l(),h()}),$(".js-rent-radio").on("change",function(){l()}),$("#buy_count").on("change",function(){l()}),$(".input-wrap").on("click",".add",function(){var t=$("#buy_count");t.val(parseInt(t.val())+1),parseInt(t.val())>100&&t.val(100),l(),p(),h()}).on("click",".min",function(){var t=$("#buy_count"),n=o.attr("min");t.val(parseInt(t.val())-1),parseInt(t.val())<n&&t.val(n),l(),p(),h()}).on("click",".input-disabled",function(){base.toast("最短租赁时长为"+$("#buy_count")[0].min+"小时")}),h(),p(),l(),$("#buy_count").val($("#buy_count").attr("min")),$(".content-wrap").on("click",".content-inner",function(){$(this).addClass("active").siblings().removeClass("active"),$("#buy_count").val($(this).attr("min")),d=0,h(),l(),p()});var v=$("#more_coupon");if(v.parent().is(":visible")){var m,f=$(".order-couponList");v.on("change",function(){m||(m=f[0].scrollHeight),f.css("height",this.checked?m:100)})}});